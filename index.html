<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Theme colors for different modes -->
    <meta name="theme-color" content="#667eea" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1a1a2e" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#667eea">
    
    <!-- Mobile web app meta tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Hitas hintalaskuri">
    
    <title>Hitas hintalaskuri</title>
    <meta name="description" content="Laske Hitas-asuntosi nykyinen velaton enimm√§ishinta k√§ytt√§en virallisia rakennuskustannus- ja markkinahintaindeksej√§.">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://vepasto.github.io/rajahinta/">
    <meta property="og:title" content="Hitas hintalaskuri">
    <meta property="og:description" content="Laske Hitas-asuntosi nykyinen velaton enimm√§ishinta k√§ytt√§en virallisia rakennuskustannus- ja markkinahintaindeksej√§.">
    <!-- Landscape image for Facebook/Twitter -->
    <meta property="og:image" content="https://vepasto.github.io/rajahinta/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <!-- Square image for WhatsApp (must be last og:image) -->
    <meta property="og:image" content="https://vepasto.github.io/rajahinta/og-image-square.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="1200">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://vepasto.github.io/rajahinta/">
    <meta name="twitter:title" content="Hitas hintalaskuri">
    <meta name="twitter:description" content="Laske Hitas-asuntosi nykyinen velaton enimm√§ishinta k√§ytt√§en virallisia rakennuskustannus- ja markkinahintaindeksej√§.">
    <meta name="twitter:image" content="https://vepasto.github.io/rajahinta/og-image.png">
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea'/%3E%3Cstop offset='100%25' style='stop-color:%23764ba2'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23bg)'/%3E%3Cg fill='white'%3E%3Cpath d='M50 25 L70 45 L70 75 L30 75 L30 45 Z'/%3E%3Crect x='40' y='55' width='8' height='12'/%3E%3Crect x='52' y='55' width='8' height='12'/%3E%3C/g%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            background-color: #667eea;
        }

        /* Navigation */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-container {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            padding: 12px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .nav-links {
            display: flex;
            gap: 30px;
        }

        .nav-container .theme-toggle {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .nav-link {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
            position: relative;
        }

        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .nav-link.active {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            font-weight: 600;
        }

        /* Skip to main content link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #667eea;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 0 0 4px 0;
            z-index: 200;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Focus indicators */
        *:focus-visible {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 70px 20px 20px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.05;
            background-image: url('house-pattern.svg');
            background-size: 80px 80px;
            pointer-events: none;
            z-index: 0;
        }

        .header, .container, .footer {
            position: relative;
            z-index: 1;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            position: relative;
            max-width: 600px;
            width: 100%;
            padding: 0 20px 20px 20px;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            padding: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            -webkit-tap-highlight-color: transparent;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .theme-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border-radius: 50%;
            transition: all 0.3s;
            opacity: 0.5;
        }

        .theme-icon.active {
            background: rgba(255, 255, 255, 0.3);
            opacity: 1;
        }

        h1 {
            color: white;
            margin-bottom: 10px;
            padding-top: 20px;
            font-size: 32px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-transform: uppercase;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.95);
            text-align: center;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .subtitle.small {
            font-size: 12px;
            color: #999;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            margin-top: 10px;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-hint {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .label-with-tooltip {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: help;
        }

        .info-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .info-icon:hover {
            opacity: 1;
        }

        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            padding: 10px 12px;
            background: #333;
            color: white;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.5;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
            max-width: 250px;
            white-space: normal;
            width: max-content;
        }

        .info-tooltip:hover .tooltip-content {
            opacity: 1;
        }

        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
        }

        body.dark-mode .info-icon {
            background: #9ca3ff;
        }

        body.dark-mode .tooltip-content {
            background: #1a1a2e;
            border: 1px solid #444;
        }

        body.dark-mode .tooltip-content::after {
            border-top-color: #1a1a2e;
        }

        body:not(.light-mode) .info-icon {
            background: #9ca3ff;
        }

        body:not(.light-mode) .tooltip-content {
            background: #1a1a2e;
            border: 1px solid #444;
        }

        body:not(.light-mode) .tooltip-content::after {
            border-top-color: #1a1a2e;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .improvements-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #e0e0e0;
        }

        #improvementsList {
            display: block;
            overflow: visible;
        }

        .improvement-item {
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .improvement-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .improvement-item-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .btn-remove {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 0 0 auto;
        }

        .btn-remove:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .btn-add-improvement {
            background: transparent;
            color: #667eea;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
            opacity: 0.7;
        }

        .btn-add-improvement:hover {
            opacity: 1;
            background: rgba(102, 126, 234, 0.05);
            border-color: #667eea;
        }

        body.dark-mode .improvements-section {
            border-top-color: #444;
        }

        body.dark-mode .improvement-item {
            background: rgba(255, 255, 255, 0.05);
            border-color: #444;
        }

        body.dark-mode .improvement-item-title {
            color: #e0e0e0;
        }

        body:not(.light-mode) .improvements-section {
            border-top-color: #444;
        }

        body:not(.light-mode) .improvement-item {
            background: rgba(255, 255, 255, 0.05);
            border-color: #444;
        }

        body:not(.light-mode) .improvement-item-title {
            color: #e0e0e0;
        }

        body.dark-mode .btn-add-improvement {
            color: #9ca3ff;
            border-color: #9ca3ff;
        }

        body.dark-mode .btn-add-improvement:hover {
            background: rgba(156, 163, 255, 0.1);
            border-color: #9ca3ff;
        }

        body:not(.light-mode) .btn-add-improvement {
            color: #9ca3ff;
            border-color: #9ca3ff;
        }

        body:not(.light-mode) .btn-add-improvement:hover {
            background: rgba(156, 163, 255, 0.1);
            border-color: #9ca3ff;
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .result {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
        }

        .result.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInNumber {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .result.show .result-price {
            animation: fadeInNumber 0.6s ease-out 0.2s both;
        }

        .result.show .result-change {
            animation: fadeInNumber 0.6s ease-out 0.3s both;
        }

        .result-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .result-price {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .result-change {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .result-improvements {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .calculation-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            margin-top: 15px;
            cursor: pointer;
            transition: background 0.3s;
            user-select: none;
        }

        .calculation-toggle:hover {
            background: rgba(255, 255, 255, 0.7);
        }

        .calculation-toggle strong {
            color: #333;
            font-size: 14px;
        }

        .toggle-arrow {
            transition: transform 0.3s;
            font-size: 12px;
            opacity: 0.7;
        }

        .toggle-arrow.expanded {
            transform: rotate(180deg);
        }

        .result-info {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            margin-top: 8px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }

        .result-info a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.3s;
        }

        .result-info a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .result-info.expanded {
            max-height: none;
            padding: 15px;
        }

        .result-info:not(.expanded) {
            padding: 0 15px;
        }

        .price-chart-container {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }

        .price-chart-container canvas {
            max-height: 300px;
        }

        @media (max-width: 768px) {
            .price-chart-container canvas {
                max-height: 500px;
            }
        }

        .result-info strong {
            color: #333;
        }

        .improvement-detail-box {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 5px;
        }

        body.dark-mode .improvement-detail-box {
            background: rgba(0, 0, 0, 0.3);
        }

        body:not(.light-mode) .improvement-detail-box {
            background: rgba(0, 0, 0, 0.3);
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 13px;
            color: #856404;
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 12px;
            opacity: 0.9;
        }

        .footer a {
            color: white;
            text-decoration: underline;
        }

        .house-icon {
            display: inline-block;
            margin-top: 15px;
            cursor: pointer;
            opacity: 0.3;
            transition: all 0.3s;
        }

        .house-icon:hover {
            opacity: 0.6;
            transform: scale(1.1);
        }

        .house-icon svg {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        /* Snake Game Styles */
        #snakeGame {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #snakeGame.active {
            display: flex;
        }

        .game-container {
            text-align: center;
        }

        .game-header {
            color: white;
            margin-bottom: 20px;
        }

        .game-header h2 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .game-score {
            font-size: 24px;
            color: #fff;
            margin-bottom: 10px;
        }

        #gameCanvas {
            border: 3px solid #667eea;
            border-radius: 10px;
            background: #1a1a2e;
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
            touch-action: none; /* Prevent default touch behaviors */
        }

        .game-controls {
            margin-top: 20px;
            color: white;
            font-size: 14px;
        }

        .game-controls p {
            margin: 5px 0;
        }

        .close-game {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 24px;
            transition: all 0.3s;
        }

        .close-game:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .game-over-message {
            color: #e74c3c;
            font-size: 20px;
            font-weight: bold;
            margin-top: 15px;
        }

        .restart-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .restart-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* Mobile Controls */
        .mobile-controls {
            display: none;
            margin-top: 20px;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 10px;
            justify-content: center;
        }

        .control-btn {
            background: rgba(102, 126, 234, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .control-btn:active {
            background: rgba(102, 126, 234, 0.5);
            transform: scale(0.95);
        }

        .control-btn.empty {
            visibility: hidden;
        }

        /* Dark mode */
        html.dark-mode {
            background-color: #1a1a2e;
        }

        body.dark-mode {
            background-color: #1a1a2e;
            background: linear-gradient(135deg, #1a1a2e 0%, #2d1b4e 100%);
        }

        body.dark-mode h1 {
            color: #e0e0e0;
        }

        body.dark-mode .subtitle {
            color: #b0b0b0;
        }

        body.dark-mode .subtitle.small {
            color: #888;
        }

        body.dark-mode .container {
            background: #2a2a3e;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        }

        body.dark-mode label {
            color: #e0e0e0;
        }

        body.dark-mode input,
        body.dark-mode select {
            background: #1a1a2e;
            color: #e0e0e0;
            border-color: #444;
        }

        body.dark-mode input:focus,
        body.dark-mode select:focus {
            border-color: #667eea;
            background: #252538;
        }

        body.dark-mode .form-section-title {
            color: #e0e0e0;
        }

        body.dark-mode .result {
            background: #1a1a2e;
            border: 1px solid #444;
        }

        body.dark-mode .calculation-toggle {
            background: rgba(255, 255, 255, 0.05);
        }

        body.dark-mode .calculation-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .calculation-toggle strong {
            color: #d0d0d0;
        }

        body.dark-mode .result-info {
            background: #15151f;
            color: #d0d0d0;
        }

        body.dark-mode .result-info a {
            color: #9ca3ff;
        }

        body.dark-mode .result-info a:hover {
            color: #b8bcff;
        }

        body.dark-mode .result-info.expanded {
            padding: 15px;
        }

        body.dark-mode .price-chart-container {
            background: #15151f;
        }

        body.dark-mode #chartNote {
            background: rgba(255, 193, 7, 0.2);
            color: #d0d0d0;
        }

        body.dark-mode .result-title {
            color: #b0b0b0;
        }

        body.dark-mode .result-price {
            color: #e0e0e0;
        }

        body.dark-mode .result-info strong {
            color: #f0f0f0;
        }

        body.dark-mode .warning {
            background: rgba(231, 76, 60, 0.15);
            border-color: #e74c3c;
            color: #ff9999;
        }

        body.dark-mode .footer {
            color: #b0b0b0;
        }

        body.dark-mode .footer a {
            color: #b0b0b0;
        }

        body.dark-mode .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        body.dark-mode .theme-icon.active {
            background: rgba(255, 255, 255, 0.2);
        }

        body.dark-mode *:focus-visible {
            outline-color: #9ca3ff;
        }

        body.dark-mode button:focus-visible,
        body.dark-mode input:focus-visible,
        body.dark-mode select:focus-visible {
            outline-color: #9ca3ff;
        }

        body.dark-mode .container .disclaimer {
            background: rgba(255, 255, 255, 0.05) !important;
            color: #b0b0b0 !important;
        }

        body.dark-mode .container a[href="info.html"] {
            color: #9ca3ff !important;
        }

        .container a[href="info.html"]:hover {
            opacity: 1 !important;
        }

        body.dark-mode .top-nav {
            background: rgba(26, 26, 46, 0.6);
        }

        body.dark-mode .nav-link {
            color: #e0e0e0;
        }

        body.dark-mode .nav-link:hover {
            background: rgba(156, 163, 255, 0.15);
            color: #9ca3ff;
        }

        body.dark-mode .nav-link.active {
            background: rgba(156, 163, 255, 0.2);
            color: #9ca3ff;
        }

        /* Auto dark mode based on system preference */
        @media (prefers-color-scheme: dark) {
            body:not(.light-mode) {
                background-color: #1a1a2e;
                background: linear-gradient(135deg, #1a1a2e 0%, #2d1b4e 100%);
            }

            body:not(.light-mode) h1 {
                color: #e0e0e0;
            }

            body:not(.light-mode) .subtitle {
                color: #b0b0b0;
            }

            body:not(.light-mode) .subtitle.small {
                color: #888;
            }

            body:not(.light-mode) .container {
                background: #2a2a3e;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            }

            body:not(.light-mode) label {
                color: #e0e0e0;
            }

            body:not(.light-mode) input,
            body:not(.light-mode) select {
                background: #1a1a2e;
                color: #e0e0e0;
                border-color: #444;
            }

            body:not(.light-mode) input:focus,
            body:not(.light-mode) select:focus {
                border-color: #667eea;
                background: #252538;
            }

            body:not(.light-mode) .form-section-title {
                color: #e0e0e0;
            }

            body:not(.light-mode) .result {
                background: #1a1a2e;
                border: 1px solid #444;
            }

            body:not(.light-mode) .calculation-toggle {
                background: rgba(255, 255, 255, 0.05);
            }

            body:not(.light-mode) .calculation-toggle:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            body:not(.light-mode) .calculation-toggle strong {
                color: #d0d0d0;
            }

            body:not(.light-mode) .result-info {
                background: #15151f;
                color: #d0d0d0;
            }

            body:not(.light-mode) .result-info a {
                color: #9ca3ff;
            }

            body:not(.light-mode) .result-info a:hover {
                color: #b8bcff;
            }

            body:not(.light-mode) .result-info.expanded {
                padding: 15px;
            }

            body:not(.light-mode) .price-chart-container {
                background: #15151f;
            }

            body:not(.light-mode) #chartNote {
                background: rgba(255, 193, 7, 0.2);
                color: #d0d0d0;
            }

            body:not(.light-mode) .result-title {
                color: #b0b0b0;
            }

            body:not(.light-mode) .result-price {
                color: #e0e0e0;
            }

            body:not(.light-mode) .result-info strong {
                color: #f0f0f0;
            }

            body:not(.light-mode) .warning {
                background: rgba(231, 76, 60, 0.15);
                border-color: #e74c3c;
                color: #ff9999;
            }

            body:not(.light-mode) .footer {
                color: #b0b0b0;
            }

            body:not(.light-mode) .footer a {
                color: #b0b0b0;
            }

            body:not(.light-mode) .theme-toggle {
                background: rgba(255, 255, 255, 0.1);
            }

            body:not(.light-mode) .theme-toggle:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            body:not(.light-mode) .theme-icon.active {
                background: rgba(255, 255, 255, 0.2);
            }

            body:not(.light-mode) *:focus-visible {
                outline-color: #9ca3ff;
            }

            body:not(.light-mode) button:focus-visible,
            body:not(.light-mode) input:focus-visible,
            body:not(.light-mode) select:focus-visible {
                outline-color: #9ca3ff;
            }

            body:not(.light-mode) .container .disclaimer {
                background: rgba(255, 255, 255, 0.05) !important;
                color: #b0b0b0 !important;
            }

            body:not(.light-mode) .container a[href="info.html"] {
                color: #9ca3ff !important;
            }

            body:not(.light-mode) .top-nav {
                background: rgba(26, 26, 46, 0.6);
            }

            body:not(.light-mode) .nav-link {
                color: #e0e0e0;
            }

            body:not(.light-mode) .nav-link:hover {
                background: rgba(156, 163, 255, 0.15);
                color: #9ca3ff;
            }

            body:not(.light-mode) .nav-link.active {
                background: rgba(156, 163, 255, 0.2);
                color: #9ca3ff;
            }
        }

        @media (max-width: 768px) {
            .mobile-controls {
                display: grid;
            }

            .game-controls p {
                font-size: 12px;
            }

            #gameCanvas {
                width: 90vw !important;
                height: 90vw !important;
                max-width: 400px !important;
                max-height: 400px !important;
            }

            .game-header h2 {
                font-size: 24px;
            }

            .game-score {
                font-size: 18px;
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 24px;
                padding-top: 45px;
            }

            .theme-toggle {
                padding: 2px;
                gap: 2px;
            }

            .theme-icon {
                width: 24px;
                height: 24px;
                font-size: 16px;
            }

            .nav-container .theme-toggle {
                right: 10px;
            }

            .nav-links {
                gap: 15px;
            }

            .nav-link {
                font-size: 13px;
                padding: 6px 12px;
            }

            .result-price {
                font-size: 28px;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Siirry sis√§lt√∂√∂n</a>
    
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-links">
                <a href="./" class="nav-link active">Hintalaskuri</a>
                <a href="./info/" class="nav-link">Info</a>
                <a href="./graphs/" class="nav-link">Graafit</a>
            </div>
            <button class="theme-toggle" id="themeToggle" aria-label="Vaihda teemaa" aria-live="polite">
                <span class="theme-icon" id="lightIcon">‚òº</span>
                <span class="theme-icon" id="darkIcon">‚òæ</span>
            </button>
        </div>
    </nav>
    
    <header class="header">
        <h1>Hitas hintalaskuri</h1>
        <p class="subtitle">Laske Hitas-asuntosi nykyinen velaton enimm√§ishinta</p>
    </header>

    <main id="main-content" class="container">
        <form id="calculatorForm">
            <div class="form-group">
                <label for="originalPrice">Alkuper√§inen velaton hankintahinta (‚Ç¨)</label>
                <input type="number" id="originalPrice" name="originalPrice" required min="0">
            </div>

            <div class="form-group">
                <label for="apartmentSize">Asunnon pinta-ala (m¬≤)</label>
                <input type="number" id="apartmentSize" name="apartmentSize" required min="1" step="0.5">
            </div>

            <div class="form-section-title">Valmistumisaika</div>

            <div class="form-row">
                <div class="form-group">
                    <label for="purchaseYear">Vuosi</label>
                    <select id="purchaseYear" name="purchaseYear" required></select>
                </div>

                <div class="form-group">
                    <label for="purchaseMonth">Kuukausi</label>
                    <select id="purchaseMonth" name="purchaseMonth" required>
                        <option value="1">Tammikuu</option>
                        <option value="2">Helmikuu</option>
                        <option value="3">Maaliskuu</option>
                        <option value="4">Huhtikuu</option>
                        <option value="5">Toukokuu</option>
                        <option value="6">Kes√§kuu</option>
                        <option value="7">Hein√§kuu</option>
                        <option value="8">Elokuu</option>
                        <option value="9">Syyskuu</option>
                        <option value="10">Lokakuu</option>
                        <option value="11">Marraskuu</option>
                        <option value="12">Joulukuu</option>
                    </select>
                </div>
            </div>

            <div class="improvements-section">
                <div class="form-section-title">Yhti√∂n parannukset</div>
                <div id="improvementsList"></div>
                <button type="button" class="btn-add-improvement" id="addImprovementBtn">+ Lis√§√§ parannus</button>
            </div>

            <div class="button-group">
                <button type="submit" class="btn-primary">Laske enimm√§ishinta</button>
            </div>

            <div class="disclaimer" style="margin-top: 8px; padding: 8px 12px; background: rgba(255, 255, 255, 0.5); border-radius: 8px; text-align: center; font-size: 13px; color: #666;">
                <em>Huom! T√§m√§ on ep√§virallinen lomake ja tarkoitettu vain suuntaa antavaksi.</em>
            </div>
        </form>

        <div id="result" class="result" role="region" aria-live="polite" aria-atomic="true">
            <div class="result-title">Velaton enimm√§ishinta</div>
            <div class="result-price" id="resultPrice" aria-label="Laskettu enimm√§ishinta"></div>
            <div class="result-change" id="resultChange" aria-label="Hinnanmuutos"></div>
            <div class="result-improvements" id="resultImprovements" aria-label="Parannukset" style="display: none;"></div>
            <div class="price-chart-container" id="priceChartContainer" style="display: none;">
                <canvas id="priceChart"></canvas>
                <div id="chartNote" style="margin-top: 12px; padding: 10px; background: rgba(255, 193, 7, 0.1); border-left: 3px solid #ffc107; font-size: 13px; display: none;"></div>
            </div>
            <button class="calculation-toggle" id="calculationToggle" aria-expanded="false" aria-controls="resultInfo">
                <strong>Laskenta</strong>
                <span class="toggle-arrow" aria-hidden="true">‚ñº</span>
            </button>
            <div class="result-info" id="resultInfo" role="region" aria-label="Laskentadetaljit" aria-hidden="true"></div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <a href="./info/" style="color: #667eea; text-decoration: none; font-weight: 500; font-size: 14px; display: inline-flex; align-items: center; gap: 5px; opacity: 0.85; transition: opacity 0.3s;">
                ‚Üí Lue lis√§√§ Hitas-asunnoista ja hinnoittelusta
            </a>
        </div>
    </main>

    <footer class="footer">
        <p style="display: flex; align-items: center; justify-content: center; gap: 5px;">
            <span>vibe coded by</span>
            <a href="https://github.com/vepasto" target="_blank" rel="noopener noreferrer" style="display: flex; align-items: center; gap: 5px; text-decoration: none; color: white;" aria-label="GitHub profiili: vepasto">
                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                vepasto
            </a>
        </p>
        <div class="house-icon" id="houseButton">
            <svg width="30" height="30" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <g fill="white" fill-opacity="0.8">
                    <path d="M50 10 L70 30 L70 50 L30 50 L30 30 Z"/>
                    <rect x="40" y="35" width="8" height="10"/>
                    <rect x="52" y="35" width="8" height="10"/>
                </g>
            </svg>
        </div>
    </footer>

    <!-- Snake Game Overlay -->
    <div id="snakeGame">
        <div class="close-game" id="closeGame">√ó</div>
        <div class="game-container">
            <div class="game-header">
                <h2>üè† Hitas Snake üè†</h2>
                <div class="game-score">Pisteet: <span id="score">0</span></div>
                <div class="game-score" style="font-size: 16px;">Enn√§tys: <span id="highScore">0</span></div>
            </div>
            <canvas id="gameCanvas" width="400" height="400"></canvas>
            <div id="gameOverContainer"></div>
            <div class="game-controls">
                <p>üéÆ K√§yt√§ nuolin√§pp√§imi√§ tai WASD</p>
                <p>üè† Ker√§√§ taloja kasvaaksesi!</p>
                <p>‚ö†Ô∏è √Ñl√§ t√∂rm√§√§ reunoihin tai itseesi!</p>
            </div>
            <div class="mobile-controls">
                <div class="control-btn empty"></div>
                <div class="control-btn" data-direction="up">‚ñ≤</div>
                <div class="control-btn empty"></div>
                <div class="control-btn" data-direction="left">‚óÑ</div>
                <div class="control-btn empty"></div>
                <div class="control-btn" data-direction="right">‚ñ∫</div>
                <div class="control-btn empty"></div>
                <div class="control-btn" data-direction="down">‚ñº</div>
                <div class="control-btn empty"></div>
            </div>
        </div>
    </div>

    <script>
        // Indeksit ladataan JSON-tiedostosta
        let rakennuskustannusindeksi = {};
        let markkinahintaindeksi = {};
        let vanhatMarkkinahintaindeksi = {};
        let rajaneliohinta = null;
        let indicesLoaded = false;
        let indicesData = null; // Store raw JSON data for charts

        // Find the latest indices file by trying dates backwards from today
        async function findLatestIndicesFile() {
            const maxDaysBack = 30; // Try up to 30 days back
            
            // Start from today and go backwards
            const today = new Date();
            for (let daysBack = 0; daysBack < maxDaysBack; daysBack++) {
                const date = new Date(today);
                date.setDate(date.getDate() - daysBack);
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const filename = `data/indices-${year}-${month}-${day}.json`;
                
                try {
                    const response = await fetch(filename);
                    if (response.ok) {
                        return filename;
                    }
                } catch (e) {
                    continue;
                }
            }
            
            throw new Error('Could not find any indices file');
        }

        // Validate indices data structure
        function validateIndicesData(data) {
            const errors = [];
            
            // Check required fields
            if (!data) {
                errors.push('Data is null or undefined');
                return errors;
            }
            
            if (!data.rakennuskustannusindeksi || typeof data.rakennuskustannusindeksi !== 'object') {
                errors.push('rakennuskustannusindeksi is missing or invalid');
            }
            
            if (!data.markkinahintaindeksi || typeof data.markkinahintaindeksi !== 'object') {
                errors.push('markkinahintaindeksi is missing or invalid');
            }
            
            // Optional fields (just log warnings)
            if (data.vanhat_markkinahintaindeksi && typeof data.vanhat_markkinahintaindeksi !== 'object') {
                console.warn('vanhat_markkinahintaindeksi has invalid format');
            }
            
            if (data.rajaneliohinta && typeof data.rajaneliohinta !== 'object') {
                console.warn('rajaneliohinta has invalid format');
            }
            
            return errors;
        }

        // Safely parse index data with error handling
        function parseIndexData(indexData, indexName) {
            const parsed = {};
            
            if (!indexData || typeof indexData !== 'object') {
                console.warn(`${indexName} is missing or invalid`);
                return parsed;
            }
            
            try {
                for (const [yearStr, months] of Object.entries(indexData)) {
                    const year = parseInt(yearStr);
                    if (isNaN(year)) {
                        console.warn(`Invalid year in ${indexName}: ${yearStr}`);
                        continue;
                    }
                    
                    parsed[year] = {};
                    if (!months || typeof months !== 'object') {
                        console.warn(`Invalid months data for year ${year} in ${indexName}`);
                        continue;
                    }
                    
                    for (const [monthStr, value] of Object.entries(months)) {
                        const month = parseInt(monthStr);
                        if (isNaN(month) || month < 1 || month > 12) {
                            console.warn(`Invalid month in ${indexName} for year ${year}: ${monthStr}`);
                            continue;
                        }
                        
                        const numValue = typeof value === 'number' ? value : parseFloat(value);
                        if (isNaN(numValue)) {
                            console.warn(`Invalid value in ${indexName} for ${year}-${month}: ${value}`);
                            continue;
                        }
                        
                        parsed[year][month] = numValue;
                    }
                }
            } catch (error) {
                console.error(`Error parsing ${indexName}:`, error);
            }
            
            return parsed;
        }

        // Lataa indeksit JSON-tiedostosta
        async function loadIndices() {
            try {
                // Find the latest indices file automatically
                const indicesFile = await findLatestIndicesFile();
                const response = await fetch(indicesFile);
                if (!response.ok) {
                    throw new Error(`Failed to load indices file: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Validate data structure
                const validationErrors = validateIndicesData(data);
                if (validationErrors.length > 0) {
                    throw new Error(`Invalid indices data structure: ${validationErrors.join(', ')}`);
                }
                
                // Store raw data for charts
                indicesData = data;
                
                // Parse indices data safely
                rakennuskustannusindeksi = parseIndexData(data.rakennuskustannusindeksi, 'rakennuskustannusindeksi');
                markkinahintaindeksi = parseIndexData(data.markkinahintaindeksi, 'markkinahintaindeksi');
                
                // Parse optional indices
                if (data.vanhat_markkinahintaindeksi) {
                    vanhatMarkkinahintaindeksi = parseIndexData(data.vanhat_markkinahintaindeksi, 'vanhat_markkinahintaindeksi');
                } else {
                    vanhatMarkkinahintaindeksi = {};
                }
                
                // Parse rajaneli√∂hinta safely
                if (data.rajaneliohinta) {
                    try {
                        // Validate rajaneli√∂hinta structure
                        if (typeof data.rajaneliohinta === 'object' && 
                            typeof data.rajaneliohinta.price_per_sqm === 'number' &&
                            data.rajaneliohinta.valid_from &&
                            data.rajaneliohinta.valid_until) {
                            rajaneliohinta = data.rajaneliohinta;
                        } else {
                            console.warn('rajaneliohinta has invalid structure, skipping');
                            rajaneliohinta = null;
                        }
                    } catch (error) {
                        console.error('Error parsing rajaneliohinta:', error);
                        rajaneliohinta = null;
                    }
                } else {
                    rajaneliohinta = null;
                }
                
                // Check if we have minimum required data
                const hasRakennuskustannus = Object.keys(rakennuskustannusindeksi).length > 0;
                const hasMarkkinahinta = Object.keys(markkinahintaindeksi).length > 0;
                
                if (!hasRakennuskustannus || !hasMarkkinahinta) {
                    throw new Error('Required indices data is empty or invalid');
                }
                
                indicesLoaded = true;
                return true;
            } catch (error) {
                console.error('Error loading indices:', error);
                indicesLoaded = false;
                // Show user-friendly error message
                const errorMsg = error.message || 'Tuntematon virhe';
                alert(`Virhe: Indeksien lataus ep√§onnistui.\n\n${errorMsg}\n\nP√§ivit√§ sivu ja yrit√§ uudelleen.`);
                return false;
            }
        }

        const monthNames = ['Tammikuu', 'Helmikuu', 'Maaliskuu', 'Huhtikuu', 'Toukokuu', 'Kes√§kuu', 
                           'Hein√§kuu', 'Elokuu', 'Syyskuu', 'Lokakuu', 'Marraskuu', 'Joulukuu'];

        // Initialize year dropdown
        function initializeYearDropdown() {
            const yearSelect = document.getElementById('purchaseYear');
            const currentYear = new Date().getFullYear();
            const startYear = 1978; // Vanhemmat indeksit alkavat 1978 alkaen
            
            for (let year = currentYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        // Initialize year dropdown for improvements
        function initializeImprovementYearDropdown(selectElement, selectedYear = null) {
            const currentYear = new Date().getFullYear();
            const startYear = 1978;
            
            selectElement.innerHTML = '';
            for (let year = currentYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (selectedYear && year === selectedYear) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            }
        }

        // Improvements management
        let improvementCounter = 0;

        // Update improvement numbering dynamically
        function updateImprovementNumbers() {
            const improvementItems = document.querySelectorAll('.improvement-item');
            improvementItems.forEach((item, index) => {
                const titleElement = item.querySelector('.improvement-item-title');
                if (titleElement) {
                    titleElement.textContent = `Parannus ${index + 1}`;
                }
            });
        }

        function addImprovement(improvementData = null) {
            const improvementsList = document.getElementById('improvementsList');
            const improvementIndex = improvementCounter++;
            
            const improvementItem = document.createElement('div');
            improvementItem.className = 'improvement-item';
            improvementItem.dataset.index = improvementIndex;
            
            const price = improvementData ? improvementData.price : '';
            const year = improvementData ? improvementData.year : null;
            const month = improvementData ? improvementData.month : null;
            
            // Get current number of improvements for display
            const currentCount = improvementsList.children.length;
            
            improvementItem.innerHTML = `
                <div class="improvement-item-header">
                    <span class="improvement-item-title">Parannus ${currentCount + 1}</span>
                    <button type="button" class="btn-remove" onclick="removeImprovement(${improvementIndex})">Poista</button>
                </div>
                <div class="form-group">
                    <label for="improvementPrice_${improvementIndex}" class="label-with-tooltip">
                        <span>Huoneistoon kohdistuva hinta (‚Ç¨)</span>
                        <span class="info-tooltip">
                            <span class="info-icon">?</span>
                            <span class="tooltip-content">
                                Huoneiston osuus lasketaan huoneiston ja yhti√∂n pinta-alojen suhteessa.<br>
                                Esim. huoneisto 60 m¬≤ / yhti√∂ 2400 m¬≤ = 2,5%
                            </span>
                        </span>
                    </label>
                    <input type="number" id="improvementPrice_${improvementIndex}" 
                           class="improvement-price" data-index="${improvementIndex}" 
                           min="0" step="100" value="${price}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="improvementYear_${improvementIndex}">Valmistumisvuosi</label>
                        <select id="improvementYear_${improvementIndex}" 
                                class="improvement-year" data-index="${improvementIndex}"></select>
                    </div>
                    <div class="form-group">
                        <label for="improvementMonth_${improvementIndex}">Valmistumiskuukausi</label>
                        <select id="improvementMonth_${improvementIndex}" 
                                class="improvement-month" data-index="${improvementIndex}">
                            <option value="1" ${month === 1 ? 'selected' : ''}>Tammikuu</option>
                            <option value="2" ${month === 2 ? 'selected' : ''}>Helmikuu</option>
                            <option value="3" ${month === 3 ? 'selected' : ''}>Maaliskuu</option>
                            <option value="4" ${month === 4 ? 'selected' : ''}>Huhtikuu</option>
                            <option value="5" ${month === 5 ? 'selected' : ''}>Toukokuu</option>
                            <option value="6" ${month === 6 ? 'selected' : ''}>Kes√§kuu</option>
                            <option value="7" ${month === 7 ? 'selected' : ''}>Hein√§kuu</option>
                            <option value="8" ${month === 8 ? 'selected' : ''}>Elokuu</option>
                            <option value="9" ${month === 9 ? 'selected' : ''}>Syyskuu</option>
                            <option value="10" ${month === 10 ? 'selected' : ''}>Lokakuu</option>
                            <option value="11" ${month === 11 ? 'selected' : ''}>Marraskuu</option>
                            <option value="12" ${month === 12 ? 'selected' : ''}>Joulukuu</option>
                        </select>
                    </div>
                </div>
            `;
            
            improvementsList.appendChild(improvementItem);
            
            // Initialize year dropdown
            const yearSelect = document.getElementById(`improvementYear_${improvementIndex}`);
            initializeImprovementYearDropdown(yearSelect, year);
            
            // Update all numbers
            updateImprovementNumbers();
            
            // Update localStorage with current improvements
            const savedData = loadFromLocalStorage();
            if (savedData) {
                const currentImprovements = getImprovements();
                saveToLocalStorage({
                    ...savedData,
                    improvements: currentImprovements
                });
            }
        }

        // Make removeImprovement globally accessible
        window.removeImprovement = function(index) {
            const improvementItem = document.querySelector(`.improvement-item[data-index="${index}"]`);
            if (improvementItem) {
                improvementItem.remove();
                // Update numbering after removal
                updateImprovementNumbers();
                
                // Update localStorage with current improvements
                const savedData = loadFromLocalStorage();
                if (savedData) {
                    const currentImprovements = getImprovements();
                    saveToLocalStorage({
                        ...savedData,
                        improvements: currentImprovements
                    });
                }
            }
        };

        function getImprovements() {
            const improvements = [];
            const improvementItems = document.querySelectorAll('.improvement-item');
            
            improvementItems.forEach(item => {
                const index = item.dataset.index;
                const priceInput = document.getElementById(`improvementPrice_${index}`);
                const yearSelect = document.getElementById(`improvementYear_${index}`);
                const monthSelect = document.getElementById(`improvementMonth_${index}`);
                
                if (priceInput && yearSelect && monthSelect) {
                    const price = parseFloat(priceInput.value);
                    const year = parseInt(yearSelect.value);
                    const month = parseInt(monthSelect.value);
                    
                    if (!isNaN(price) && price > 0 && year && month) {
                        improvements.push({ price, year, month });
                    }
                }
            });
            
            return improvements;
        }

        // Get the latest available index value (not in the future)
        function getLatestIndex(indexData) {
            // Validate input
            if (!indexData || typeof indexData !== 'object' || Object.keys(indexData).length === 0) {
                return null;
            }
            
            try {
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1; // JavaScript months are 0-11
                
                const years = Object.keys(indexData).map(Number).filter(y => !isNaN(y)).sort((a, b) => b - a);
                
                for (const year of years) {
                    // Skip future years
                    if (year > currentYear) continue;
                    
                    if (!indexData[year] || typeof indexData[year] !== 'object') {
                        continue;
                    }
                    
                    const months = Object.keys(indexData[year]).map(Number).filter(m => !isNaN(m)).sort((a, b) => b - a);
                    for (const month of months) {
                        // Skip future months in current year
                        if (year === currentYear && month > currentMonth) continue;
                        
                        const value = indexData[year][month];
                        if (typeof value === 'number' && !isNaN(value)) {
                            return {
                                value: value,
                                year: year,
                                month: month
                            };
                        }
                    }
                }
            } catch (error) {
                console.error('Error in getLatestIndex:', error);
            }
            
            return null;
        }

        // Get index value for a specific date
        function getIndexValue(indexData, year, month) {
            // Validate input
            if (!indexData || typeof indexData !== 'object') {
                return null;
            }
            
            if (typeof year !== 'number' || isNaN(year) || typeof month !== 'number' || isNaN(month)) {
                return null;
            }
            
            try {
                if (indexData[year] && typeof indexData[year] === 'object' && 
                    indexData[year][month] !== undefined) {
                    const value = indexData[year][month];
                    if (typeof value === 'number' && !isNaN(value)) {
                        return value;
                    }
                }
            } catch (error) {
                console.error('Error in getIndexValue:', error);
            }
            
            return null;
        }

        // Format price in euros
        function formatPrice(price) {
            return new Intl.NumberFormat('fi-FI', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(price);
        }

        // Format price compactly for charts (e.g., 305000 -> 305k ‚Ç¨)
        function formatPriceCompact(price) {
            if (price >= 1000) {
                return Math.round(price / 1000) + 'k ‚Ç¨';
            }
            return Math.round(price) + ' ‚Ç¨';
        }

        // Calculate indexed value for a single improvement
        function getImprovementIndexedValue(improvement, apartmentSize) {
            const omavastuu = apartmentSize * 30; // 30 ‚Ç¨/m¬≤
            
            // If improvement price is less than or equal to omavastuu, no indexing
            if (improvement.price <= omavastuu) {
                return {
                    originalPrice: improvement.price,
                    omavastuu: omavastuu,
                    indexedValue: 0,
                    indexedAmount: 0,
                    usedIndex: null,
                    improvementYear: improvement.year,
                    improvementMonth: improvement.month
                };
            }
            
            // Amount to be indexed (price exceeding omavastuu)
            const amountToIndex = improvement.price - omavastuu;
            
            // Check if improvement was completed before 2011
            const isBefore2011 = improvement.year < 2011;
            
            let indexedValue = 0;
            let usedIndex = null;
            
            if (isBefore2011) {
                // Use old market price index
                const improvementOldMarket = getIndexValue(vanhatMarkkinahintaindeksi, improvement.year, improvement.month);
                const currentOldMarket = getLatestIndex(vanhatMarkkinahintaindeksi);
                
                if (improvementOldMarket && currentOldMarket) {
                    indexedValue = (amountToIndex * currentOldMarket.value) / improvementOldMarket;
                    usedIndex = {
                        name: 'Vanhojen osakeasuntojen hintaindeksi',
                        type: 'vanhatMarkkinahinta',
                        improvementIndex: improvementOldMarket,
                        currentIndex: currentOldMarket
                    };
                }
            } else {
                // Use both indices and choose the higher one
                const improvementRk = getIndexValue(rakennuskustannusindeksi, improvement.year, improvement.month);
                const improvementMh = getIndexValue(markkinahintaindeksi, improvement.year, improvement.month);
                const currentRk = getLatestIndex(rakennuskustannusindeksi);
                const currentMh = getLatestIndex(markkinahintaindeksi);
                
                let rkValue = 0;
                let mhValue = 0;
                
                if (improvementRk && currentRk) {
                    rkValue = (amountToIndex * currentRk.value) / improvementRk;
                }
                
                if (improvementMh && currentMh) {
                    mhValue = (amountToIndex * currentMh.value) / improvementMh;
                }
                
                // Choose the higher value
                if (rkValue >= mhValue && rkValue > 0) {
                    indexedValue = rkValue;
                    usedIndex = {
                        name: 'Rakennuskustannusindeksi',
                        type: 'rakennuskustannus',
                        improvementIndex: improvementRk,
                        currentIndex: currentRk
                    };
                } else if (mhValue > 0) {
                    indexedValue = mhValue;
                    usedIndex = {
                        name: 'Markkinahintaindeksi',
                        type: 'markkinahinta',
                        improvementIndex: improvementMh,
                        currentIndex: currentMh
                    };
                }
            }
            
            return {
                originalPrice: improvement.price,
                omavastuu: omavastuu,
                indexedValue: indexedValue,
                indexedAmount: amountToIndex,
                usedIndex: usedIndex,
                improvementYear: improvement.year,
                improvementMonth: improvement.month
            };
        }

        // Calculate total improvements impact
        function calculateImprovements(improvements, apartmentSize) {
            if (!improvements || improvements.length === 0) {
                return {
                    totalIndexedValue: 0,
                    improvements: []
                };
            }
            
            const improvementResults = improvements.map(improvement => 
                getImprovementIndexedValue(improvement, apartmentSize)
            );
            
            const totalIndexedValue = improvementResults.reduce((sum, result) => sum + result.indexedValue, 0);
            
            return {
                totalIndexedValue: totalIndexedValue,
                improvements: improvementResults
            };
        }

        // Calculate rajahinta
        function calculateRajahinta(originalPrice, purchaseYear, purchaseMonth, apartmentSize, improvements = []) {
            const results = {
                rakennuskustannus: null,
                markkinahinta: null,
                vanhatMarkkinahinta: null,
                rajaneliohinta: null,
                improvements: null
            };

            // Check if apartment was completed before 2011
            const isBefore2011 = purchaseYear < 2011;

            if (isBefore2011) {
                // Use old market price index for apartments completed before 2011
                const purchaseOldMarket = getIndexValue(vanhatMarkkinahintaindeksi, purchaseYear, purchaseMonth);
                const currentOldMarket = getLatestIndex(vanhatMarkkinahintaindeksi);

                if (purchaseOldMarket && currentOldMarket) {
                    results.vanhatMarkkinahinta = {
                        price: (originalPrice * currentOldMarket.value) / purchaseOldMarket,
                        currentIndex: currentOldMarket,
                        purchaseIndex: purchaseOldMarket
                    };
                }
            } else {
                // Use rakennuskustannus and markkinahinta indices for apartments from 2011 onwards
                // Get purchase indices
                const purchaseRakennuskustannus = getIndexValue(rakennuskustannusindeksi, purchaseYear, purchaseMonth);
                const purchaseMarkkinahinta = getIndexValue(markkinahintaindeksi, purchaseYear, purchaseMonth);

                // Get current indices
                const currentRakennuskustannus = getLatestIndex(rakennuskustannusindeksi);
                const currentMarkkinahinta = getLatestIndex(markkinahintaindeksi);

                // Calculate with Rakennuskustannusindeksi
                if (purchaseRakennuskustannus && currentRakennuskustannus) {
                    results.rakennuskustannus = {
                        price: (originalPrice * currentRakennuskustannus.value) / purchaseRakennuskustannus,
                        currentIndex: currentRakennuskustannus,
                        purchaseIndex: purchaseRakennuskustannus
                    };
                }

                // Calculate with Markkinahintaindeksi
                if (purchaseMarkkinahinta && currentMarkkinahinta) {
                    results.markkinahinta = {
                        price: (originalPrice * currentMarkkinahinta.value) / purchaseMarkkinahinta,
                        currentIndex: currentMarkkinahinta,
                        purchaseIndex: purchaseMarkkinahinta
                    };
                }
            }

            // Calculate improvements impact
            if (improvements && improvements.length > 0) {
                const improvementsResult = calculateImprovements(improvements, apartmentSize);
                results.improvements = improvementsResult;
                
                // Add improvements to index prices (not to rajaneli√∂hinta)
                if (results.rakennuskustannus) {
                    results.rakennuskustannus.price += improvementsResult.totalIndexedValue;
                }
                if (results.markkinahinta) {
                    results.markkinahinta.price += improvementsResult.totalIndexedValue;
                }
                if (results.vanhatMarkkinahinta) {
                    results.vanhatMarkkinahinta.price += improvementsResult.totalIndexedValue;
                }
            }

            // Calculate rajaneli√∂hinta (applies to all Hitas apartments, improvements NOT added)
            if (rajaneliohinta && apartmentSize) {
                results.rajaneliohinta = {
                    price: apartmentSize * rajaneliohinta.price_per_sqm,
                    pricePerSqm: rajaneliohinta.price_per_sqm,
                    apartmentSize: apartmentSize,
                    validFrom: rajaneliohinta.valid_from,
                    validUntil: rajaneliohinta.valid_until
                };
            }

            return results;
        }

        // Save to localStorage
        function saveToLocalStorage(data) {
            localStorage.setItem('hitasCalculatorData', JSON.stringify(data));
        }

        // Load from localStorage
        function loadFromLocalStorage() {
            const data = localStorage.getItem('hitasCalculatorData');
            return data ? JSON.parse(data) : null;
        }

        // Clear localStorage
        function clearLocalStorage() {
            localStorage.removeItem('hitasCalculatorData');
        }

        // Display result
        let priceChartInstance = null;
        let currentChartData = null; // Store current chart data for theme switching

        function createPriceChart(purchaseYear, purchaseMonth, originalPrice) {
            const chartContainer = document.getElementById('priceChartContainer');
            const canvas = document.getElementById('priceChart');
            
            // Store data for theme switching
            currentChartData = { purchaseYear, purchaseMonth, originalPrice };
            
            // Destroy existing chart
            if (priceChartInstance) {
                priceChartInstance.destroy();
                priceChartInstance = null;
            }
            
            // Helper function to convert index object to sorted data points
            function getDataPoints(indexDataObj, purchaseIndex) {
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1;
                
                const dataPoints = [];
                for (const [year, months] of Object.entries(indexDataObj)) {
                    for (const [month, value] of Object.entries(months)) {
                        const y = parseInt(year);
                        const m = parseInt(month);
                        
                        // Only include data from purchase date onwards, but not in the future
                        const isAfterPurchase = y > purchaseYear || (y === purchaseYear && m >= purchaseMonth);
                        const isNotFuture = y < currentYear || (y === currentYear && m <= currentMonth);
                        
                        if (isAfterPurchase && isNotFuture) {
                            dataPoints.push({
                                year: y,
                                month: m,
                                value: value,
                                price: (value / purchaseIndex) * originalPrice
                            });
                        }
                    }
                }
                // Sort by year and month
                dataPoints.sort((a, b) => {
                    if (a.year !== b.year) return a.year - b.year;
                    return a.month - b.month;
                });
                return dataPoints;
            }
            
            // Prepare datasets
            const datasets = [];
            let labels = [];
            
            // For post-2011 apartments, show both indices
            if (purchaseYear >= 2011) {
                // Get both index data
                const rkPurchaseIndex = rakennuskustannusindeksi[purchaseYear]?.[purchaseMonth];
                const mhPurchaseIndex = markkinahintaindeksi[purchaseYear]?.[purchaseMonth];
                
                if (rkPurchaseIndex && mhPurchaseIndex) {
                    const rkDataPoints = getDataPoints(indicesData.rakennuskustannusindeksi, rkPurchaseIndex);
                    const mhDataPoints = getDataPoints(indicesData.markkinahintaindeksi, mhPurchaseIndex);
                    
                    if (rkDataPoints.length > 0 && mhDataPoints.length > 0) {
                        // Use the longer array for labels
                        const allLabels = new Set();
                        rkDataPoints.forEach(dp => allLabels.add(`${dp.month}/${dp.year}`));
                        mhDataPoints.forEach(dp => allLabels.add(`${dp.month}/${dp.year}`));
                        
                        // Create label-to-data maps
                        const rkMap = new Map(rkDataPoints.map(dp => [`${dp.month}/${dp.year}`, dp.price]));
                        const mhMap = new Map(mhDataPoints.map(dp => [`${dp.month}/${dp.year}`, dp.price]));
                        
                        // Sort labels chronologically
                        labels = Array.from(allLabels).sort((a, b) => {
                            const [m1, y1] = a.split('/').map(Number);
                            const [m2, y2] = b.split('/').map(Number);
                            if (y1 !== y2) return y1 - y2;
                            return m1 - m2;
                        });
                        
                        // Add purchase point at the beginning
                        labels.unshift(`${purchaseMonth}/${purchaseYear}`);
                        
                        const rkPrices = [originalPrice, ...labels.slice(1).map(l => rkMap.get(l) || null)];
                        const mhPrices = [originalPrice, ...labels.slice(1).map(l => mhMap.get(l) || null)];
                        
                        // Determine colors based on theme
                        const isDark = document.body.classList.contains('dark-mode') || 
                                       (!document.body.classList.contains('light-mode') && 
                                        window.matchMedia('(prefers-color-scheme: dark)').matches);
                        
                        const rkColor = isDark ? '#9ca3ff' : '#667eea';
                        const mhColor = isDark ? '#ff9cba' : '#e74c3c';
                        
                        datasets.push({
                            label: 'Rakennuskustannusindeksi',
                            data: rkPrices,
                            borderColor: rkColor,
                            backgroundColor: isDark ? 'rgba(156, 163, 255, 0.1)' : 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            spanGaps: true
                        });
                        
                        datasets.push({
                            label: 'Markkinahintaindeksi',
                            data: mhPrices,
                            borderColor: mhColor,
                            backgroundColor: isDark ? 'rgba(255, 156, 186, 0.1)' : 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            spanGaps: true
                        });
                    }
                }
            } else {
                // For pre-2011 apartments, show only old market index
                const vmPurchaseIndex = vanhatMarkkinahintaindeksi[purchaseYear]?.[purchaseMonth];
                
                if (!vmPurchaseIndex) {
                    chartContainer.style.display = 'none';
                    return;
                }
                
                const vmDataPoints = getDataPoints(indicesData.vanhat_markkinahintaindeksi, vmPurchaseIndex);
                
                if (vmDataPoints.length === 0) {
                    chartContainer.style.display = 'none';
                    return;
                }
                
                labels = vmDataPoints.map(dp => `${dp.month}/${dp.year}`);
                const prices = vmDataPoints.map(dp => dp.price);
                
                // Add purchase point at the beginning
                labels.unshift(`${purchaseMonth}/${purchaseYear}`);
                prices.unshift(originalPrice);
                
                const isDark = document.body.classList.contains('dark-mode') || 
                               (!document.body.classList.contains('light-mode') && 
                                window.matchMedia('(prefers-color-scheme: dark)').matches);
                
                const lineColor = isDark ? '#9ca3ff' : '#667eea';
                
                datasets.push({
                    label: 'Vanhojen osakeasuntojen hintaindeksi',
                    data: prices,
                    borderColor: lineColor,
                    backgroundColor: isDark ? 'rgba(156, 163, 255, 0.1)' : 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 5
                });
            }
            
            if (datasets.length === 0 || labels.length === 0) {
                chartContainer.style.display = 'none';
                return;
            }
            
            // Determine if dark mode
            const isDark = document.body.classList.contains('dark-mode') || 
                           (!document.body.classList.contains('light-mode') && 
                            window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            const textColor = isDark ? '#d0d0d0' : '#333';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.15)';
            
            // Use smaller aspect ratio on mobile for taller chart
            const isMobile = window.innerWidth <= 768;
            const aspectRatio = isMobile ? 1.2 : 2.5;
            
            chartContainer.style.display = 'block';
            
            priceChartInstance = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: aspectRatio,
                    plugins: {
                        legend: {
                            display: datasets.length > 1,
                            position: 'top',
                            labels: {
                                color: textColor,
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return formatPrice(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: textColor,
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 20
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        y: {
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return formatPriceCompact(value);
                                }
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    }
                }
            });
        }

        function displayResult(results, originalPrice, purchaseYear, purchaseMonth, shouldScroll = true) {
            const resultDiv = document.getElementById('result');
            const resultPrice = document.getElementById('resultPrice');
            const resultChange = document.getElementById('resultChange');
            const resultInfo = document.getElementById('resultInfo');

            let finalPrice, usedIndex, usedIndexData, purchaseIndexValue;
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;

            // Collect all calculated prices to find the highest one
            let candidates = [];
            
            // Check if using old market index (before 2011)
            if (results.vanhatMarkkinahinta) {
                candidates.push({
                    price: results.vanhatMarkkinahinta.price,
                    name: 'Vanhojen osakeasuntojen hintaindeksi (markkinahintaindeksi)',
                    type: 'vanhatMarkkinahinta',
                    data: results.vanhatMarkkinahinta
                });
            }
            
            // For 2011 and later
            if (results.rakennuskustannus) {
                candidates.push({
                    price: results.rakennuskustannus.price,
                    name: 'Rakennuskustannusindeksi',
                    type: 'rakennuskustannus',
                    data: results.rakennuskustannus
                });
            }
            
            if (results.markkinahinta) {
                candidates.push({
                    price: results.markkinahinta.price,
                    name: 'Markkinahintaindeksi',
                    type: 'markkinahinta',
                    data: results.markkinahinta
                });
            }
            
            // Always check rajaneli√∂hinta (applies to all apartments)
            if (results.rajaneliohinta) {
                candidates.push({
                    price: results.rajaneliohinta.price,
                    name: 'Rajaneli√∂hinta',
                    type: 'rajaneliohinta',
                    data: results.rajaneliohinta
                });
            }
            
            if (candidates.length === 0) {
                resultInfo.innerHTML = '<div class="warning">Virhe: Indeksitietoja ei l√∂ydy valitulle ajankohdalle.</div>';
                resultDiv.classList.add('show');
                return;
            }
            
            // Find the highest price
            const winner = candidates.reduce((max, current) => 
                current.price > max.price ? current : max
            );
            
            finalPrice = winner.price;
            usedIndex = winner.name;
            
            // Set legacy variables for display compatibility
            if (winner.type === 'vanhatMarkkinahinta' || winner.type === 'rakennuskustannus' || winner.type === 'markkinahinta') {
                usedIndexData = winner.data.currentIndex;
                purchaseIndexValue = winner.data.purchaseIndex;
            }

            resultPrice.textContent = formatPrice(finalPrice);

            // Get improvements total
            const improvementsTotal = results.improvements ? results.improvements.totalIndexedValue : 0;
            
            // Calculate base price without improvements (for change calculation)
            const basePrice = finalPrice - improvementsTotal;
            const priceChange = basePrice - originalPrice;
            const percentageChange = ((priceChange / originalPrice) * 100).toFixed(1);
            const changeSign = priceChange >= 0 ? '+' : '';
            const changeColor = priceChange >= 0 ? '#27ae60' : '#e74c3c';

            // Display change
            resultChange.innerHTML = `<span style="color: ${changeColor};">${changeSign}${formatPrice(Math.abs(priceChange))} (${changeSign}${percentageChange}%)</span>`;
            
            // Display improvements separately if they exist
            const resultImprovements = document.getElementById('resultImprovements');
            if (improvementsTotal > 0) {
                resultImprovements.style.display = 'block';
                resultImprovements.innerHTML = `<span style="color: #666;">sis. ${formatPrice(improvementsTotal)} parannukset</span>`;
            } else {
                resultImprovements.style.display = 'none';
            }

            let infoHTML = `
                Alkuper√§inen velaton hankintahinta: ${formatPrice(originalPrice)}<br>
                Valmistumisp√§iv√§: ${monthNames[purchaseMonth - 1]} ${purchaseYear}<br>
                <br>
            `;

            // Show old market index calculation for pre-2011 apartments
            if (results.vanhatMarkkinahinta) {
                const vm = results.vanhatMarkkinahinta;
                const basePrice = (originalPrice * vm.currentIndex.value) / vm.purchaseIndex;
                const improvementsTotal = results.improvements ? results.improvements.totalIndexedValue : 0;
                
                // Check if old market index is using older data
                const vmIsOld = vm.currentIndex.year < currentYear || 
                                (vm.currentIndex.year === currentYear && vm.currentIndex.month < currentMonth);
                
                infoHTML += `
                    <strong>${usedIndex}:</strong> ‚úì (k√§ytetty) 
                    <a href="./graphs/#old-indices-chart">(katso graafi ‚Üí)</a><br>
                    <div style="padding-left: 20px; margin-top: 8px;">
                        <em>Ennen 1.1.2011 valmistuneille Hitas-asunnoille k√§ytet√§√§n yht√§ indeksi√§</em><br>
                        <br>
                        Valmistumishetken indeksi: ${vm.purchaseIndex.toFixed(2)}<br>
                        Nykyinen indeksi: ${vm.currentIndex.value.toFixed(2)} (${monthNames[vm.currentIndex.month - 1]} ${vm.currentIndex.year})<br>
                        Kaava: ${vm.currentIndex.value.toFixed(2)} / ${vm.purchaseIndex.toFixed(2)} √ó ${formatPrice(originalPrice)}<br>
                        Indeksipohjainen hinta: ${formatPrice(basePrice)}<br>
                `;
                
                if (improvementsTotal > 0) {
                    infoHTML += `
                        + Parannukset: ${formatPrice(improvementsTotal)}<br>
                    `;
                }
                
                infoHTML += `
                        Tulos: ${formatPrice(vm.price)}<br>
                    </div>
                `;
                
                if (vmIsOld) {
                    infoHTML += `
                        <div class="warning" style="margin-top: 10px; margin-bottom: 10px;">
                            ‚ö†Ô∏è Huom: Laskettu ${monthNames[vm.currentIndex.month - 1]} ${vm.currentIndex.year} indeksin mukaan, 
                            koska ${monthNames[currentMonth - 1]} ${currentYear} indeksi√§ ei ole viel√§ saatavilla.
                        </div>
                    `;
                }
            }
            // Show both index calculations for post-2011 apartments
            else if (results.rakennuskustannus) {
                const rk = results.rakennuskustannus;
                const isSelected = usedIndex === 'Rakennuskustannusindeksi';
                const basePrice = (originalPrice * rk.currentIndex.value) / rk.purchaseIndex;
                const improvementsTotal = results.improvements ? results.improvements.totalIndexedValue : 0;
                
                // Check if Rakennuskustannus index is using older data
                const rkIsOld = rk.currentIndex.year < currentYear || 
                                (rk.currentIndex.year === currentYear && rk.currentIndex.month < currentMonth);
                
                infoHTML += `
                    <strong>Rakennuskustannusindeksi:</strong> ${isSelected ? '‚úì (k√§ytetty)' : ''} 
                    <a href="./graphs/#new-indices-chart">(katso graafi ‚Üí)</a><br>
                    <div style="padding-left: 20px; margin-top: 8px;">
                        Valmistumishetken indeksi: ${rk.purchaseIndex.toFixed(2)}<br>
                        Nykyinen indeksi: ${rk.currentIndex.value.toFixed(2)} (${monthNames[rk.currentIndex.month - 1]} ${rk.currentIndex.year})<br>
                        Kaava: ${rk.currentIndex.value.toFixed(2)} / ${rk.purchaseIndex.toFixed(2)} √ó ${formatPrice(originalPrice)}<br>
                        Indeksipohjainen hinta: ${formatPrice(basePrice)}<br>
                `;
                
                if (improvementsTotal > 0) {
                    infoHTML += `
                        + Parannukset: ${formatPrice(improvementsTotal)}<br>
                    `;
                }
                
                infoHTML += `
                        Tulos: ${formatPrice(rk.price)}<br>
                    </div>
                `;
                
                if (rkIsOld) {
                    infoHTML += `
                        <div class="warning" style="margin-top: 10px; margin-bottom: 10px;">
                            ‚ö†Ô∏è Huom: Laskettu ${monthNames[rk.currentIndex.month - 1]} ${rk.currentIndex.year} indeksin mukaan, 
                            koska ${monthNames[currentMonth - 1]} ${currentYear} indeksi√§ ei ole viel√§ saatavilla.
                        </div>
                    `;
                }
                
                infoHTML += '<br>';
            }

            if (results.markkinahinta) {
                const mh = results.markkinahinta;
                const isSelected = usedIndex === 'Markkinahintaindeksi';
                const basePrice = (originalPrice * mh.currentIndex.value) / mh.purchaseIndex;
                const improvementsTotal = results.improvements ? results.improvements.totalIndexedValue : 0;
                
                // Check if Markkinahinta index is using older data
                const mhIsOld = mh.currentIndex.year < currentYear || 
                                (mh.currentIndex.year === currentYear && mh.currentIndex.month < currentMonth);
                
                infoHTML += `
                    <strong>Markkinahintaindeksi:</strong> ${isSelected ? '‚úì (k√§ytetty)' : ''} 
                    <a href="./graphs/#new-indices-chart">(katso graafi ‚Üí)</a><br>
                    <div style="padding-left: 20px; margin-top: 8px;">
                        Valmistumishetken indeksi: ${mh.purchaseIndex.toFixed(2)}<br>
                        Nykyinen indeksi: ${mh.currentIndex.value.toFixed(2)} (${monthNames[mh.currentIndex.month - 1]} ${mh.currentIndex.year})<br>
                        Kaava: ${mh.currentIndex.value.toFixed(2)} / ${mh.purchaseIndex.toFixed(2)} √ó ${formatPrice(originalPrice)}<br>
                        Indeksipohjainen hinta: ${formatPrice(basePrice)}<br>
                `;
                
                if (improvementsTotal > 0) {
                    infoHTML += `
                        + Parannukset: ${formatPrice(improvementsTotal)}<br>
                    `;
                }
                
                infoHTML += `
                        Tulos: ${formatPrice(mh.price)}<br>
                    </div>
                `;
                
                if (mhIsOld) {
                    infoHTML += `
                        <div class="warning" style="margin-top: 10px; margin-bottom: 10px;">
                            ‚ö†Ô∏è Huom: Laskettu ${monthNames[mh.currentIndex.month - 1]} ${mh.currentIndex.year} indeksin mukaan, 
                            koska ${monthNames[currentMonth - 1]} ${currentYear} indeksi√§ ei ole viel√§ saatavilla.
                        </div>
                    `;
                }
            }

            // Show rajaneli√∂hinta calculation
            if (results.rajaneliohinta) {
                const rh = results.rajaneliohinta;
                const isSelected = usedIndex === 'Rajaneli√∂hinta';
                
                infoHTML += `
                    <br>
                    <strong>Rajaneli√∂hinta:</strong> ${isSelected ? '‚úì (k√§ytetty)' : ''}<br>
                    <div style="padding-left: 20px; margin-top: 8px;">
                        <em>Kaikkien Hitas-yhti√∂iden keskim√§√§r√§inen neli√∂hinta</em><br>
                        <a href="graphs/#rajaneliohinta-chart" target="_blank" rel="noopener" style="font-size: 13px; margin-top: 4px; display: inline-block;">Katso graafi ‚Üí</a><br>
                        <br>
                        Asunnon pinta-ala: ${rh.apartmentSize} m¬≤<br>
                        Rajaneli√∂hinta: ${formatPrice(rh.pricePerSqm)}/m¬≤ (voimassa ${rh.validFrom} - ${rh.validUntil})<br>
                        Kaava: ${rh.apartmentSize} m¬≤ √ó ${formatPrice(rh.pricePerSqm)}/m¬≤<br>
                        Tulos: ${formatPrice(rh.price)}<br>
                    </div>
                `;
            }

            // Show improvements
            if (results.improvements && results.improvements.improvements.length > 0) {
                const improvementsData = results.improvements;
                infoHTML += `
                    <br>
                    <strong>Parannukset:</strong><br>
                    <div style="padding-left: 20px; margin-top: 8px;">
                        <em>Parannukset lis√§t√§√§n vain indeksihintoihin, ei rajaneli√∂hintaan</em><br>
                        <br>
                `;
                
                improvementsData.improvements.forEach((imp, index) => {
                    infoHTML += `
                        <div class="improvement-detail-box">
                            <strong>Parannus ${index + 1}</strong> (${monthNames[imp.improvementMonth - 1]} ${imp.improvementYear})<br>
                            Parannuksen hinta: ${formatPrice(imp.originalPrice)}<br>
                            Omavastuu (30 ‚Ç¨/m¬≤): ${formatPrice(imp.omavastuu)}<br>
                    `;
                    
                    if (imp.indexedValue > 0) {
                        infoHTML += `
                            Indeksitarkistettava summa: ${formatPrice(imp.indexedAmount)}<br>
                            K√§ytetty indeksi: ${imp.usedIndex.name}<br>
                            Indeksitarkistettu arvo: ${formatPrice(imp.indexedValue)}<br>
                        `;
                    } else {
                        infoHTML += `
                            <em>Ei indeksitarkistusta (hinta ‚â§ omavastuu)</em><br>
                        `;
                    }
                    
                    infoHTML += `</div>`;
                });
                
                infoHTML += `
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1);">
                            <strong>Parannusten yhteens√§ indeksitarkistettu arvo: ${formatPrice(improvementsData.totalIndexedValue)}</strong><br>
                            <em>T√§m√§ summa on lis√§tty kaikkiin indeksihintoihin</em>
                        </div>
                    </div>
                `;
            }

            infoHTML = infoHTML.trim();

            resultInfo.innerHTML = infoHTML;
            resultDiv.classList.add('show');
            
            // Create price evolution chart
            createPriceChart(purchaseYear, purchaseMonth, originalPrice);
            
            // Show note if rajaneli√∂hinta wins
            const chartNote = document.getElementById('chartNote');
            if (winner.type === 'rajaneliohinta') {
                chartNote.style.display = 'block';
                chartNote.innerHTML = '<strong>‚ÑπÔ∏è Huom:</strong> Vaikka k√§yr√§t n√§ytt√§v√§t indeksien mukaisen hinnan kehityksen, k√§ytet√§√§n kuitenkin <strong>rajaneli√∂hintaa</strong> koska se on korkeampi.';
            } else {
                chartNote.style.display = 'none';
            }
            
            // Scroll to result only if requested (not on auto-load)
            if (shouldScroll) {
                setTimeout(() => {
                    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            }
        }

        // Handle form submission
        document.getElementById('calculatorForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const originalPrice = parseFloat(document.getElementById('originalPrice').value);
            const apartmentSize = parseFloat(document.getElementById('apartmentSize').value);
            const purchaseYear = parseInt(document.getElementById('purchaseYear').value);
            const purchaseMonth = parseInt(document.getElementById('purchaseMonth').value);
            const improvements = getImprovements();

            // Calculate
            // Check if indices are loaded
            if (!indicesLoaded) {
                alert('Virhe: Indeksit eiv√§t ole viel√§ ladattu. Odota hetki ja yrit√§ uudelleen.');
                return;
            }
            
            // Validate that we have required indices
            if (!rakennuskustannusindeksi || Object.keys(rakennuskustannusindeksi).length === 0 ||
                !markkinahintaindeksi || Object.keys(markkinahintaindeksi).length === 0) {
                alert('Virhe: Vaaditut indeksit puuttuvat. P√§ivit√§ sivu ja yrit√§ uudelleen.');
                return;
            }

            const results = calculateRajahinta(originalPrice, purchaseYear, purchaseMonth, apartmentSize, improvements);

            // Display result
            displayResult(results, originalPrice, purchaseYear, purchaseMonth);

            // Save to localStorage
            saveToLocalStorage({
                originalPrice,
                apartmentSize,
                purchaseYear,
                purchaseMonth,
                improvements
            });
        });

        // Theme toggle functionality (define before DOMContentLoaded)
        function setTheme(theme) {
            const lightIcon = document.getElementById('lightIcon');
            const darkIcon = document.getElementById('darkIcon');
            
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
                document.documentElement.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                document.body.classList.remove('light-mode');
                if (lightIcon) lightIcon.classList.remove('active');
                if (darkIcon) darkIcon.classList.add('active');
                localStorage.setItem('theme', 'dark');
            } else if (theme === 'light') {
                document.documentElement.classList.add('light-mode');
                document.documentElement.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                document.body.classList.remove('dark-mode');
                if (lightIcon) lightIcon.classList.add('active');
                if (darkIcon) darkIcon.classList.remove('active');
                localStorage.setItem('theme', 'light');
            } else {
                // Auto mode - follow system preference
                document.documentElement.classList.remove('dark-mode', 'light-mode');
                document.body.classList.remove('dark-mode', 'light-mode');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (lightIcon) lightIcon.classList.toggle('active', !isDark);
                if (darkIcon) darkIcon.classList.toggle('active', isDark);
                localStorage.removeItem('theme');
            }
            
            // Recreate chart with new theme colors if it exists
            if (currentChartData) {
                createPriceChart(
                    currentChartData.purchaseYear,
                    currentChartData.purchaseMonth,
                    currentChartData.originalPrice
                );
            }
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme');
            
            // Check if currently in dark mode (either manually set or from system preference)
            const isDarkNow = document.body.classList.contains('dark-mode') || 
                             (!document.body.classList.contains('light-mode') && 
                              window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            // Toggle between dark and light
            if (isDarkNow) {
                setTheme('light');
            } else {
                setTheme('dark');
            }
        }

        // Calculation toggle functionality
        function toggleCalculation() {
            const resultInfo = document.getElementById('resultInfo');
            const arrow = document.querySelector('.toggle-arrow');
            const toggleBtn = document.getElementById('calculationToggle');
            
            if (resultInfo && arrow && toggleBtn) {
                const isExpanded = resultInfo.classList.toggle('expanded');
                arrow.classList.toggle('expanded');
                
                // Update ARIA attributes for accessibility
                toggleBtn.setAttribute('aria-expanded', isExpanded);
                resultInfo.setAttribute('aria-hidden', !isExpanded);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const themeToggle = document.getElementById('themeToggle');
            
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }

            // Initialize theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                setTheme(savedTheme);
            } else {
                setTheme(null); // Auto mode
            }

            // Setup calculation toggle
            const calculationToggle = document.getElementById('calculationToggle');
            if (calculationToggle) {
                calculationToggle.addEventListener('click', toggleCalculation);
            }

            initializeYearDropdown();

            // Setup "Add improvement" button
            const addImprovementBtn = document.getElementById('addImprovementBtn');
            if (addImprovementBtn) {
                addImprovementBtn.addEventListener('click', function() {
                    addImprovement();
                });
            }

            // Lataa indeksit ensin
            await loadIndices();

            // Load saved data and auto-calculate
            const savedData = loadFromLocalStorage();
            if (savedData && indicesLoaded) {
                document.getElementById('originalPrice').value = savedData.originalPrice;
                if (savedData.apartmentSize) {
                    document.getElementById('apartmentSize').value = savedData.apartmentSize;
                }
                document.getElementById('purchaseYear').value = savedData.purchaseYear;
                document.getElementById('purchaseMonth').value = savedData.purchaseMonth;

                // Load improvements
                if (savedData.improvements && savedData.improvements.length > 0) {
                    savedData.improvements.forEach(improvement => {
                        addImprovement(improvement);
                    });
                }

                // Auto-calculate without scrolling (only if apartment size is available)
                if (savedData.apartmentSize) {
                    const improvements = savedData.improvements || [];
                    const results = calculateRajahinta(
                        savedData.originalPrice,
                        savedData.purchaseYear,
                        savedData.purchaseMonth,
                        savedData.apartmentSize,
                        improvements
                    );
                    displayResult(results, savedData.originalPrice, savedData.purchaseYear, savedData.purchaseMonth, false);
                }
            }
        });

    </script>
    
    <!-- Snake Game Easter Egg -->
        <script src="scripts/snake-game.js"></script>
</body>
</html>

